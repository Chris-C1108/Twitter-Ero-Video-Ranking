# Twitter排行榜：TikTok风格播放器 (Twitter Ranking TikTok Style Player)

这是一个 Tampermonkey/Violentmonkey 油猴脚本，为 [Twitter Ero Video Ranking](https://twitter-ero-video-ranking.com/) 和 [X-Ero-Anime](https://x-ero-anime.com/) 网站提供沉浸式的 TikTok 风格视频播放体验。

## ✨ 主要功能 (Features)

*   **🎬 沉浸式播放体验**：点击列表封面的任何视频，即可在当前页面打开全屏模态框播放，无需跳转。
*   **📱 TikTok 风格交互**：
    *   **上下滑动切换**：像刷短视频一样，上滑/下滑（或使用鼠标滚轮）自动切换到上一个/下一个视频。
    *   **无缝衔接**：自动预加载相邻视频，切换无比流畅。
*   **❤️ 收藏功能**：点击喜欢按钮直接调用网站 API 收藏视频。
*   **⬇️ 下载功能**：一键在新标签页打开视频原始链接进行下载。
*   **🔖 已观看记录**：本地记录已看视频，支持"只看未读"模式过滤。
*   **🔧 核心技术修复**：
    *   **解决 403 问题**：内置智能防盗链规避策略（Referer Spoofing），完美解决 Twitter 视频无法播放的问题。
    *   **精准提取**：使用 `LD+JSON` 解析技术，精准获取真实的高清视频地址。
*   **🚀 性能优化**：
    *   **智能预加载**：自动缓存相邻视频的前 1MB 数据，秒开播放。
    *   **内存管理**：内置 LRU 缓存清理机制，防止浏览器内存溢出。
    *   **非阻塞初始化**：使用 `requestIdleCallback` 异步采集视频。

## 🎮 操作说明 (Controls)

| 操作方式 | 功能 |
| :--- | :--- |
| **🖱️ 鼠标滚轮** | 上下切换视频 |
| **👆 触摸滑动** | 上滑下一个，下滑上一个 |
| **⌨️ 键盘 ↑ / ↓** | 上下切换视频 |
| **⌨️ 键盘 空格/Enter** | 播放/暂停 |
| **⌨️ 键盘 Esc** | 关闭播放器 |
| **❌ 关闭按钮** | 点击右上角或遮罩层空白处关闭 |
| **❤️ 喜欢按钮** | 收藏/取消收藏视频 |
| **⬇️ 下载按钮** | 在新标签页打开视频链接 |
| **🔘 未读开关** | 过滤只显示未观看的视频 |
| **📊 进度条拖放** | 点击或拖拽进度条跳转播放位置 |

## 🛠️ 怎么安装？ (Installation)

### 🍎 苹果机 (iOS)
*   **推荐方法 1**：👉 用 **「Stay for Safari」**（App Store 免费版就够用）。安装后去脚本页面，点右下角 Stay 按钮就能装上。
*   **推荐方法 2**：👉 用 **「Userscripts」**（App Store 有）。

### 🤖 安卓 / Windows / Mac
*   直接安装 **「Tampermonkey」** 插件就行了 👉 [https://www.tampermonkey.net/](https://www.tampermonkey.net/)
*   **Edge Android 版** 似乎也支持装插件了，各位可以试试。

---

## 📝 更新日志

### v2.7 (2026-01-16)
*   🖼️ **视觉稳定性优化**：修复视频切换时的画面闪烁和缩略图"鬼影"问题，确保丝滑过渡。
*   📱 **iOS 沉浸体验**：修复 iPhone 底部安全区域（Home条）显示白条的问题，实现全屏纯黑背景。
*   ⚡ **动画同步**：精细调整动画时序，消除滑动操作的顿挫感。

### v2.1.2 (2026-01-15)
*   ⚡ **0ms 秒开优化**：引入"Element Kidnap"（元素劫持）策略，直接复用后台预热的视频连接，消除 1-2 秒的缓冲等待。
*   🔮 **智能预判加载**：播放开始时立即预解析并连接后续 2 个视频，确保连续滑动时的流畅体验。
*   🛡️ **自动容错重试**：新增 403 Forbidden 错误的指数退避重试机制 (2s/4s/8s)，自动刷新过期 Token。

### v2.1.1 (2026-01-15)
*   🆕 **进度条拖放功能**：支持鼠标和触摸拖拽，实时预览目标时间点。
*   🎨 **遮罩层优化**：优化顶部和底部遮罩的渐变效果，提升视觉体验。

### v2.1 (2026-01-15)
*   🆕 新增"只看未读"切换按钮，过滤已观看视频。
*   🆕 新增下载按钮，一键获取视频原始链接。
*   🆕 喜欢按钮现调用网站 API 进行收藏。
*   🆕 本地存储已观看视频记录 (localStorage)。
*   ⚡ 优化触摸事件识别，区分滑动与点击，避免误触发。
*   🎨 全新 TikTok 风格 UI：
    *   进度条移至底部贴边 + 底部渐变遮罩
    *   操作按钮透明背景 + 图标阴影
    *   顶部渐变遮罩提升控件可见度
    *   响应式移动端优化
*   🏗️ 代码重构：提取 `getCurrentVideo()` 等辅助方法。

### v2.0
*   新增视频预加载策略 (Preload Strategy)，缓存相邻视频前 1MB 数据。
*   优化 `LD+JSON` 解析逻辑，大幅提高视频地址获取成功率。
*   增加全局 `no-referrer` 策略，彻底修复视频 403 Forbidden 错误。
*   重构 UI 样式，更接近原生 App 体验。

## ⚠️ 免责声明

本脚本仅供技术研究和学习使用，请勿用于任何非法用途。

---
**Author**: Chris_C
**License**: MIT
